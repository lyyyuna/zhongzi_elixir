// Package bencode provides bencode encoding and decoding functionality
// Bencode is a simple encoding format used by BitTorrent for serializing data
package bencode

import (
	"bytes"
	"errors"
	"fmt"
	"io"
	"reflect"
	"sort"
	"strconv"
)

var (
	ErrInvalidType     = errors.New("bencode: invalid type")
	ErrInvalidFormat   = errors.New("bencode: invalid format")
	ErrUnexpectedEnd   = errors.New("bencode: unexpected end of input")
	ErrInvalidInteger  = errors.New("bencode: invalid integer")
	ErrInvalidString   = errors.New("bencode: invalid string")
	ErrInvalidList     = errors.New("bencode: invalid list")
	ErrInvalidDict     = errors.New("bencode: invalid dictionary")
)

// BencodeEncoder provides bencode encoding functionality
type BencodeEncoder struct{}

// BencodeDecoder provides bencode decoding functionality  
type BencodeDecoder struct{}

// NewBencodeEncoder creates a new bencode encoder
func NewBencodeEncoder() *BencodeEncoder {
	return &BencodeEncoder{}
}

// NewBencodeDecoder creates a new bencode decoder
func NewBencodeDecoder() *BencodeDecoder {
	return &BencodeDecoder{}
}

// Encode encodes a value into bencode format
func (e *BencodeEncoder) Encode(v interface{}) ([]byte, error) {
	var buf bytes.Buffer
	err := e.encode(&buf, reflect.ValueOf(v))
	return buf.Bytes(), err
}

// Decode decodes bencode data into a value
func (d *BencodeDecoder) Decode(data []byte, v interface{}) error {
	reader := bytes.NewReader(data)
	return d.decode(reader, reflect.ValueOf(v).Elem())
}

// DecodeBytes decodes bencode data and returns the raw value
func (d *BencodeDecoder) DecodeBytes(data []byte) (interface{}, error) {
	reader := bytes.NewReader(data)
	return d.decodeValue(reader)
}

// Package-level convenience functions

// Encode encodes a value into bencode format
func Encode(v interface{}) ([]byte, error) {
	encoder := NewBencodeEncoder()
	return encoder.Encode(v)
}

// Decode decodes bencode data into a value
func Decode(data []byte, v interface{}) error {
	decoder := NewBencodeDecoder()
	return decoder.Decode(data, v)
}

// DecodeBytes decodes bencode data and returns the raw value
func DecodeBytes(data []byte) (interface{}, error) {
	decoder := NewBencodeDecoder()
	return decoder.DecodeBytes(data)
}

func (e *BencodeEncoder) encode(w io.Writer, v reflect.Value) error {
	switch v.Kind() {
	case reflect.String:
		return e.encodeString(w, v.String())
	case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:
		return e.encodeInt(w, v.Int())
	case reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:
		return e.encodeInt(w, int64(v.Uint()))
	case reflect.Slice:
		if v.Type().Elem().Kind() == reflect.Uint8 {
			// []byte should be encoded as string
			return e.encodeString(w, string(v.Bytes()))
		}
		return e.encodeList(w, v)
	case reflect.Array:
		if v.Type().Elem().Kind() == reflect.Uint8 {
			// [n]byte should be encoded as string
			bytes := make([]byte, v.Len())
			for i := 0; i < v.Len(); i++ {
				bytes[i] = byte(v.Index(i).Uint())
			}
			return e.encodeString(w, string(bytes))
		}
		return e.encodeList(w, v)
	case reflect.Map:
		return e.encodeDict(w, v)
	case reflect.Struct:
		return e.encodeStruct(w, v)
	case reflect.Interface:
		if v.IsNil() {
			return ErrInvalidType
		}
		return e.encode(w, v.Elem())
	case reflect.Ptr:
		if v.IsNil() {
			return ErrInvalidType
		}
		return e.encode(w, v.Elem())
	default:
		return ErrInvalidType
	}
}

func (e *BencodeEncoder) encodeString(w io.Writer, s string) error {
	_, err := fmt.Fprintf(w, "%d:%s", len(s), s)
	return err
}

func (e *BencodeEncoder) encodeInt(w io.Writer, i int64) error {
	_, err := fmt.Fprintf(w, "i%de", i)
	return err
}

func (e *BencodeEncoder) encodeList(w io.Writer, v reflect.Value) error {
	if _, err := w.Write([]byte("l")); err != nil {
		return err
	}
	
	for i := 0; i < v.Len(); i++ {
		if err := e.encode(w, v.Index(i)); err != nil {
			return err
		}
	}
	
	_, err := w.Write([]byte("e"))
	return err
}

func (e *BencodeEncoder) encodeDict(w io.Writer, v reflect.Value) error {
	if _, err := w.Write([]byte("d")); err != nil {
		return err
	}
	
	keys := v.MapKeys()
	sort.Slice(keys, func(i, j int) bool {
		return keys[i].String() < keys[j].String()
	})
	
	for _, key := range keys {
		if err := e.encodeString(w, key.String()); err != nil {
			return err
		}
		if err := e.encode(w, v.MapIndex(key)); err != nil {
			return err
		}
	}
	
	_, err := w.Write([]byte("e"))
	return err
}

func (e *BencodeEncoder) encodeStruct(w io.Writer, v reflect.Value) error {
	if _, err := w.Write([]byte("d")); err != nil {
		return err
	}
	
	t := v.Type()
	for i := 0; i < v.NumField(); i++ {
		field := t.Field(i)
		if !field.IsExported() {
			continue
		}
		
		tag := field.Tag.Get("bencode")
		if tag == "-" {
			continue
		}
		
		name := field.Name
		if tag != "" {
			name = tag
		}
		
		if err := e.encodeString(w, name); err != nil {
			return err
		}
		if err := e.encode(w, v.Field(i)); err != nil {
			return err
		}
	}
	
	_, err := w.Write([]byte("e"))
	return err
}

func (d *BencodeDecoder) decode(r io.Reader, v reflect.Value) error {
	value, err := d.decodeValue(r)
	if err != nil {
		return err
	}
	return d.setValue(v, value)
}

func (d *BencodeDecoder) decodeValue(r io.Reader) (interface{}, error) {
	b := make([]byte, 1)
	if _, err := r.Read(b); err != nil {
		return nil, err
	}
	
	switch b[0] {
	case 'i':
		return d.decodeInt(r)
	case 'l':
		return d.decodeList(r)
	case 'd':
		return d.decodeDict(r)
	case '0', '1', '2', '3', '4', '5', '6', '7', '8', '9':
		return d.decodeString(r, b[0])
	default:
		return nil, ErrInvalidFormat
	}
}

func (d *BencodeDecoder) decodeInt(r io.Reader) (int64, error) {
	var buf bytes.Buffer
	b := make([]byte, 1)
	
	for {
		if _, err := r.Read(b); err != nil {
			return 0, ErrUnexpectedEnd
		}
		if b[0] == 'e' {
			break
		}
		buf.WriteByte(b[0])
	}
	
	return strconv.ParseInt(buf.String(), 10, 64)
}

func (d *BencodeDecoder) decodeString(r io.Reader, first byte) (string, error) {
	var lengthBuf bytes.Buffer
	lengthBuf.WriteByte(first)
	
	b := make([]byte, 1)
	for {
		if _, err := r.Read(b); err != nil {
			return "", ErrUnexpectedEnd
		}
		if b[0] == ':' {
			break
		}
		lengthBuf.WriteByte(b[0])
	}
	
	length, err := strconv.Atoi(lengthBuf.String())
	if err != nil {
		return "", ErrInvalidString
	}
	
	if length < 0 {
		return "", ErrInvalidString
	}
	
	if length == 0 {
		return "", nil
	}
	
	data := make([]byte, length)
	if _, err := io.ReadFull(r, data); err != nil {
		return "", ErrUnexpectedEnd
	}
	
	return string(data), nil
}

func (d *BencodeDecoder) decodeList(r io.Reader) ([]interface{}, error) {
	var list []interface{}
	b := make([]byte, 1)
	
	for {
		if _, err := r.Read(b); err != nil {
			return nil, ErrUnexpectedEnd
		}
		if b[0] == 'e' {
			break
		}
		
		// Put the byte back by creating a new reader with the byte prepended
		if br, ok := r.(*bytes.Reader); ok {
			remaining := make([]byte, br.Len()+1)
			remaining[0] = b[0]
			n, _ := br.Read(remaining[1:])
			r = bytes.NewReader(remaining[:n+1])
		} else {
			return nil, errors.New("unsupported reader type for seeking")
		}
		
		value, err := d.decodeValue(r)
		if err != nil {
			return nil, err
		}
		list = append(list, value)
	}
	
	return list, nil
}

func (d *BencodeDecoder) decodeDict(r io.Reader) (map[string]interface{}, error) {
	dict := make(map[string]interface{})
	b := make([]byte, 1)
	
	for {
		if _, err := r.Read(b); err != nil {
			return nil, ErrUnexpectedEnd
		}
		if b[0] == 'e' {
			break
		}
		
		// Keys must be strings
		key, err := d.decodeString(r, b[0])
		if err != nil {
			return nil, err
		}
		
		value, err := d.decodeValue(r)
		if err != nil {
			return nil, err
		}
		
		dict[key] = value
	}
	
	return dict, nil
}

func (d *BencodeDecoder) setValue(v reflect.Value, value interface{}) error {
	switch v.Kind() {
	case reflect.String:
		if s, ok := value.(string); ok {
			v.SetString(s)
			return nil
		}
		return ErrInvalidType
	case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:
		if i, ok := value.(int64); ok {
			v.SetInt(i)
			return nil
		}
		return ErrInvalidType
	case reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:
		if i, ok := value.(int64); ok && i >= 0 {
			v.SetUint(uint64(i))
			return nil
		}
		return ErrInvalidType
	case reflect.Slice:
		if list, ok := value.([]interface{}); ok {
			slice := reflect.MakeSlice(v.Type(), len(list), len(list))
			for i, item := range list {
				if err := d.setValue(slice.Index(i), item); err != nil {
					return err
				}
			}
			v.Set(slice)
			return nil
		}
		// Handle []byte specially for strings
		if v.Type().Elem().Kind() == reflect.Uint8 {
			if s, ok := value.(string); ok {
				v.SetBytes([]byte(s))
				return nil
			}
		}
		return ErrInvalidType
	case reflect.Map:
		if dict, ok := value.(map[string]interface{}); ok {
			mapType := v.Type()
			newMap := reflect.MakeMap(mapType)
			for key, val := range dict {
				keyVal := reflect.ValueOf(key)
				valVal := reflect.New(mapType.Elem()).Elem()
				if err := d.setValue(valVal, val); err != nil {
					return err
				}
				newMap.SetMapIndex(keyVal, valVal)
			}
			v.Set(newMap)
			return nil
		}
		return ErrInvalidType
	case reflect.Interface:
		v.Set(reflect.ValueOf(value))
		return nil
	default:
		return ErrInvalidType
	}
}